name: OSS Guardrails

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  oss-artifact-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build OSS package
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Assert enterprise/ is not packaged
        run: |
          python - <<'PY'
          import glob
          import zipfile
          import sys
          wheel = glob.glob('dist/*.whl')
          if not wheel:
              raise SystemExit('No wheel found in dist/')
          wheel = wheel[0]
          z = zipfile.ZipFile(wheel)
          bad = [n for n in z.namelist() if n.startswith('enterprise/')]
          if bad:
              print('Found enterprise files in wheel:')
              for n in bad[:50]:
                  print(' -', n)
              raise SystemExit(1)
          print('OK: no enterprise/ in wheel', wheel)
          PY

      - name: OSS-only import + CLI smoke test
        run: |
          python -m venv .venv_smoke
          ./.venv_smoke/bin/python -m pip install --upgrade pip
          ./.venv_smoke/bin/python -m pip install dist/*.whl

          ./.venv_smoke/bin/python -I -c "import importlib.util; assert importlib.util.find_spec('enterprise') is None"
          ./.venv_smoke/bin/python -I -c "import genxai; print('genxai version:', genxai.__version__)"
          ./.venv_smoke/bin/genxai --help
